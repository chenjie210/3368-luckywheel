<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lucky Draw Wheel</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f4f8;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    min-height: 100vh;
    margin: 0;
  }
  h1 {
    color: #333;
  }
  #idInputContainer {
    margin: 20px 0;
  }
  input[type="text"] {
    padding: 10px;
    font-size: 16px;
    width: 220px;
    border: 2px solid #333;
    border-radius: 6px;
  }
  button {
    padding: 10px 20px;
    margin-left: 10px;
    font-size: 16px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s;
  }
  button:disabled {
    background: #aaa;
    cursor: not-allowed;
  }
  button:hover:not(:disabled) {
    background: #45a049;
  }
  #wheelContainer {
    position: relative;
    width: 350px;
    height: 350px;
    margin: 20px auto;
  }
  canvas#wheel {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
  }
  /* Stylish arrow */
  #arrow {
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    width: 0; 
    height: 0; 
    border-left: 20px solid transparent;
    border-right: 20px solid transparent;
    border-bottom: 30px solid #e74c3c;
    filter: drop-shadow(0 0 3px rgba(0,0,0,0.3));
  }

  #result {
    margin-top: 20px;
    font-size: 20px;
    color: #222;
    min-height: 30px;
  }

  #prizesList {
    margin-top: 30px;
    max-width: 350px;
    background: white;
    border-radius: 10px;
    padding: 15px 20px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
  }

  #prizesList h2 {
    margin-top: 0;
    text-align: center;
    color: #444;
  }

  #prizesList ul {
    list-style: none;
    padding: 0;
  }
  #prizesList li {
    padding: 8px 0;
    border-bottom: 1px solid #ddd;
    font-size: 16px;
    color: #555;
  }
  #prizesList li:last-child {
    border-bottom: none;
  }
</style>
</head>
<body>
  <h1>Lucky Draw Wheel</h1>
  <div id="idInputContainer">
    <input type="text" id="userId" placeholder="Enter your ID" />
    <button id="spinBtn" disabled>Spin</button>
  </div>

  <div id="wheelContainer">
    <div id="arrow"></div>
    <canvas id="wheel" width="350" height="350"></canvas>
  </div>

  <div id="result"></div>

  <div id="prizesList">
    <h2>Prizes</h2>
    <ul>
      <li>10M RRS or 4M Coins</li>
      <li>5M RRS or 2M Coins</li>
      <li>Thank You for Participating</li>
    </ul>
  </div>

<script>
  const canvas = document.getElementById('wheel');
  const ctx = canvas.getContext('2d');
  const spinBtn = document.getElementById('spinBtn');
  const userIdInput = document.getElementById('userId');
  const resultDiv = document.getElementById('result');

  // Prizes info
  const segments = [
    { text: "10M RRS or 4M Coins", color: "#f39c12" },   // 5%
    { text: "5M RRS or 2M Coins", color: "#27ae60" },    // 10%
    { text: "Thank You for Participating", color: "#7f8c8d" } // 85%
  ];

  // Probability mapping for 100 scale
  // 0-4: prize1 (5%)
  // 5-14: prize2 (10%)
  // 15-99: prize3 (85%)
  // We'll map this to wheel slices accordingly

  // To make wheel segments proportional, let's divide the wheel accordingly:
  // 5% slice, 10% slice, 85% slice
  // Angles: 360*0.05=18deg, 360*0.10=36deg, 360*0.85=306deg

  // So segments:
  // Segment 0: 18deg
  // Segment 1: 36deg
  // Segment 2: 306deg

  // Store cumulative angles for logic
  const angles = [18, 36, 306];

  // Total segments count = 3

  let startAngles = [];
  let currentAngle = 0;
  for(let a of angles) {
    startAngles.push(currentAngle);
    currentAngle += a;
  }

  // Draw wheel
  function drawWheel(rotation = 0) {
    const cx = canvas.width / 2;
    const cy = canvas.height / 2;
    const radius = Math.min(cx, cy) - 10;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    for(let i=0; i < segments.length; i++) {
      const startAngle = (startAngles[i] + rotation) * Math.PI / 180;
      const endAngle = (startAngles[i] + angles[i] + rotation) * Math.PI / 180;
      // Draw slice
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, radius, startAngle, endAngle);
      ctx.closePath();
      ctx.fillStyle = segments[i].color;
      ctx.fill();

      // Draw text along the middle of the slice
      ctx.save();
      ctx.fillStyle = "white";
      ctx.translate(cx, cy);
      const midAngle = (startAngles[i] + angles[i]/2 + rotation) * Math.PI / 180;
      ctx.rotate(midAngle);
      ctx.textAlign = "right";
      ctx.font = "bold 16px Arial";
      ctx.fillText(segments[i].text, radius - 10, 10);
      ctx.restore();
    }
  }

  drawWheel(0);

  // LocalStorage key prefix
  const LS_KEY = 'luckyDrawSpunIds';

  // Load spun IDs from localStorage
  function loadSpunIds() {
    const data = localStorage.getItem(LS_KEY);
    if(data) {
      try {
        return JSON.parse(data);
      } catch {
        return [];
      }
    }
    return [];
  }

  // Save spun IDs
  function saveSpunIds(ids) {
    localStorage.setItem(LS_KEY, JSON.stringify(ids));
  }

  // Check if ID has spun
  function hasSpun(id) {
    const ids = loadSpunIds();
    return ids.includes(id);
  }

  // Add ID to spun list
  function addSpun(id) {
    const ids = loadSpunIds();
    ids.push(id);
    saveSpunIds(ids);
  }

  // Enable or disable spin button depending on input
  userIdInput.addEventListener('input', () => {
    const id = userIdInput.value.trim();
    if(id.length > 0 && !hasSpun(id)) {
      spinBtn.disabled = false;
      resultDiv.textContent = "";
    } else if (hasSpun(id)) {
      spinBtn.disabled = true;
      resultDiv.textContent = "This ID has already participated.";
    } else {
      spinBtn.disabled = true;
      resultDiv.textContent = "";
    }
  });

  // Spin logic variables
  let isSpinning = false;
  let rotation = 0;

  // Function to pick prize based on probability
  function pickPrize() {
    const rand = Math.random() * 100;
    if(rand < 5) return 0;        // 5%
    else if(rand < 15) return 1;  // next 10%
    else return 2;                // 85%
  }

  // Calculate final rotation angle to land prize at arrow (top)
  function getRotationForPrize(prizeIndex) {
    // Arrow is at 0 degrees (top)
    // We want the prize slice middle to be aligned at 0 deg
    // So rotation angle = 360 - (startAngle + sliceAngle/2)
    const prizeMidAngle = startAngles[prizeIndex] + angles[prizeIndex] / 2;
    return (360 * 5) + (360 - prizeMidAngle); // 5 full rotations + final align
  }

  function animateSpin(targetRotation, duration=4000) {
    return new Promise(resolve => {
      const start = performance.now();
      const initialRotation = rotation % 360;

      function animate(time) {
        const elapsed = time - start;
        if(elapsed < duration) {
          // Ease out cubic
          const t = elapsed / duration;
          const easedT = 1 - Math.pow(1 - t, 3);
          rotation = initialRotation + easedT * (targetRotation - initialRotation);
          drawWheel(rotation % 360);
          requestAnimationFrame(animate);
        } else {
          rotation = targetRotation % 360;
          drawWheel(rotation);
          resolve();
        }
      }
      requestAnimationFrame(animate);
    });
  }

  spinBtn.addEventListener('click', async () => {
    if(isSpinning) return;
    const id = userIdInput.value.trim();
    if(!id || hasSpun(id)) return;

    isSpinning = true;
    spinBtn.disabled = true;
    resultDiv.textContent = "Spinning...";

    const prizeIndex = pickPrize();
    const finalRotation = getRotationForPrize(prizeIndex);

    await animateSpin(finalRotation, 4000);

    addSpun(id);

    let prizeText = segments[prizeIndex].text;

    resultDiv.textContent = `Congrats! You won: ${prizeText}`;

    isSpinning = false;
    spinBtn.disabled = true;
  });
</script>

</body>
</html>
